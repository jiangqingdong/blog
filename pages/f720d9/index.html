<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.62" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://mister-hope.github.io/pages/f720d9/"><meta property="og:site_name" content="学习笔记"><meta property="og:title" content="RocketMQ快速实战以及集群架构解析"><meta property="og:description" content="RocketMQ介绍 ​	RocketMQ是阿里巴巴开源的一个消息中间件，在阿里内部历经了双十一等很多高并发场景的考验，能够处理亿万级别的消息。2016年开源后捐赠给Apache，现在是Apache的一个顶级项目。 ​	目前RocketMQ在阿里云上有一个购买即可用的商业版本，商业版本集成了阿里内部一些更深层次的功能及运维定制。我们这里学习的是Apache的开源版本。开源版本相对于阿里云上的商业版本，功能上略有缺失，但是大体上功能是一样的。 RocketMQ的发展历程 ​	早期阿里使用ActiveMQ，但是，当消息开始逐渐增多后，ActiveMQ的IO性能很快达到了瓶颈。于是，阿里开始关注Kafka。但是Kafka是针对日志收集场景设计的，他的并发性能并不是很理想。尤其当他的Topic过多时，由于Partition文件也会过多，会严重影响IO性能。于是阿里才决定自研中间件，最早叫做MetaQ，后来改名成为RocketMQ。最早他所希望解决的最大问题就是多Topic下的IO性能压力。但是产品在阿里内部的不断改进，RocketMQ开始体现出一些不一样的优势。"><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2023-08-01T18:24:48.000Z"><meta property="article:author" content="江"><meta property="article:published_time" content="2022-11-13T13:46:11.000Z"><meta property="article:modified_time" content="2023-08-01T18:24:48.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"RocketMQ快速实战以及集群架构解析","image":[""],"datePublished":"2022-11-13T13:46:11.000Z","dateModified":"2023-08-01T18:24:48.000Z","author":[{"@type":"Person","name":"江"}]}</script><title>RocketMQ快速实战以及集群架构解析 | 学习笔记</title><meta name="description" content="RocketMQ介绍 ​	RocketMQ是阿里巴巴开源的一个消息中间件，在阿里内部历经了双十一等很多高并发场景的考验，能够处理亿万级别的消息。2016年开源后捐赠给Apache，现在是Apache的一个顶级项目。 ​	目前RocketMQ在阿里云上有一个购买即可用的商业版本，商业版本集成了阿里内部一些更深层次的功能及运维定制。我们这里学习的是Apache的开源版本。开源版本相对于阿里云上的商业版本，功能上略有缺失，但是大体上功能是一样的。 RocketMQ的发展历程 ​	早期阿里使用ActiveMQ，但是，当消息开始逐渐增多后，ActiveMQ的IO性能很快达到了瓶颈。于是，阿里开始关注Kafka。但是Kafka是针对日志收集场景设计的，他的并发性能并不是很理想。尤其当他的Topic过多时，由于Partition文件也会过多，会严重影响IO性能。于是阿里才决定自研中间件，最早叫做MetaQ，后来改名成为RocketMQ。最早他所希望解决的最大问题就是多Topic下的IO性能压力。但是产品在阿里内部的不断改进，RocketMQ开始体现出一些不一样的优势。">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d1e1f;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style-d225b157.css" as="style"><link rel="stylesheet" href="/assets/style-d225b157.css">
    <link rel="modulepreload" href="/assets/app-21ce620e.js"><link rel="modulepreload" href="/assets/index.html-881fba3f.js"><link rel="modulepreload" href="/assets/index.html-5ba307b5.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-c27b6911.js"><link rel="prefetch" href="/assets/intro.html-d050d194.js" as="script"><link rel="prefetch" href="/assets/index.html-3841b971.js" as="script"><link rel="prefetch" href="/assets/slides.html-4bcf9c90.js" as="script"><link rel="prefetch" href="/assets/index.html-9da1f986.js" as="script"><link rel="prefetch" href="/assets/index.html-06aa5afc.js" as="script"><link rel="prefetch" href="/assets/index.html-3cde2e9d.js" as="script"><link rel="prefetch" href="/assets/04-Spring之Bean生命周期源码解析上.html-e29efed5.js" as="script"><link rel="prefetch" href="/assets/index.html-056a7c7b.js" as="script"><link rel="prefetch" href="/assets/index.html-196aee9a.js" as="script"><link rel="prefetch" href="/assets/index.html-15356fd6.js" as="script"><link rel="prefetch" href="/assets/index.html-b2ea937f.js" as="script"><link rel="prefetch" href="/assets/index.html-fae2cce2.js" as="script"><link rel="prefetch" href="/assets/index.html-3de3ac13.js" as="script"><link rel="prefetch" href="/assets/index.html-4fc833f7.js" as="script"><link rel="prefetch" href="/assets/index.html-a9380d59.js" as="script"><link rel="prefetch" href="/assets/index.html-0c227f79.js" as="script"><link rel="prefetch" href="/assets/index.html-ca9e9edd.js" as="script"><link rel="prefetch" href="/assets/index.html-3d73ef7f.js" as="script"><link rel="prefetch" href="/assets/index.html-eff3b4ec.js" as="script"><link rel="prefetch" href="/assets/index.html-63004bbb.js" as="script"><link rel="prefetch" href="/assets/index.html-b443c91f.js" as="script"><link rel="prefetch" href="/assets/index.html-eb7dc294.js" as="script"><link rel="prefetch" href="/assets/index.html-b3f10bbb.js" as="script"><link rel="prefetch" href="/assets/index.html-6036577c.js" as="script"><link rel="prefetch" href="/assets/index.html-58352f8e.js" as="script"><link rel="prefetch" href="/assets/index.html-47cee948.js" as="script"><link rel="prefetch" href="/assets/index.html-1460385b.js" as="script"><link rel="prefetch" href="/assets/00.站在全局视角理解系统高并发.html-3a469a4c.js" as="script"><link rel="prefetch" href="/assets/index.html-1fffc64f.js" as="script"><link rel="prefetch" href="/assets/10.BIO NIO编程与直接内存零拷贝.html-0ab5e5cc.js" as="script"><link rel="prefetch" href="/assets/index.html-a1cae865.js" as="script"><link rel="prefetch" href="/assets/index.html-e045b02c.js" as="script"><link rel="prefetch" href="/assets/index.html-ab40fe3b.js" as="script"><link rel="prefetch" href="/assets/100.高并发缓存实战.html-58f47ed2.js" as="script"><link rel="prefetch" href="/assets/index.html-78dacd72.js" as="script"><link rel="prefetch" href="/assets/30.微服务架构拆分实战.html-d6647704.js" as="script"><link rel="prefetch" href="/assets/index.html-59afda48.js" as="script"><link rel="prefetch" href="/assets/50.微服务网关整合OAuth2.0授权中心.html-d969e8ed.js" as="script"><link rel="prefetch" href="/assets/index.html-edca6dc4.js" as="script"><link rel="prefetch" href="/assets/index.html-1ae26749.js" as="script"><link rel="prefetch" href="/assets/index.html-f93219f2.js" as="script"><link rel="prefetch" href="/assets/index.html-31118532.js" as="script"><link rel="prefetch" href="/assets/工厂模式.html-ad9410a3.js" as="script"><link rel="prefetch" href="/assets/建造模式.html-a04d73b9.js" as="script"><link rel="prefetch" href="/assets/index.html-c071222c.js" as="script"><link rel="prefetch" href="/assets/index.html-a4f315bf.js" as="script"><link rel="prefetch" href="/assets/index.html-b0022173.js" as="script"><link rel="prefetch" href="/assets/index.html-38e14dc8.js" as="script"><link rel="prefetch" href="/assets/index.html-cc3cc56c.js" as="script"><link rel="prefetch" href="/assets/index.html-fbcf9615.js" as="script"><link rel="prefetch" href="/assets/index.html-4cecd512.js" as="script"><link rel="prefetch" href="/assets/index.html-99ad6842.js" as="script"><link rel="prefetch" href="/assets/index.html-675c676e.js" as="script"><link rel="prefetch" href="/assets/index.html-2855e279.js" as="script"><link rel="prefetch" href="/assets/index.html-68bfa6a5.js" as="script"><link rel="prefetch" href="/assets/index.html-859c676b.js" as="script"><link rel="prefetch" href="/assets/index.html-fe205ef8.js" as="script"><link rel="prefetch" href="/assets/index.html-0cb20f1c.js" as="script"><link rel="prefetch" href="/assets/index.html-102cfae4.js" as="script"><link rel="prefetch" href="/assets/index.html-ae48c1df.js" as="script"><link rel="prefetch" href="/assets/index.html-814f7f1d.js" as="script"><link rel="prefetch" href="/assets/index.html-19779ea0.js" as="script"><link rel="prefetch" href="/assets/index.html-09cc3a43.js" as="script"><link rel="prefetch" href="/assets/index.html-cccbb13c.js" as="script"><link rel="prefetch" href="/assets/index.html-b8130103.js" as="script"><link rel="prefetch" href="/assets/index.html-1b4e8107.js" as="script"><link rel="prefetch" href="/assets/index.html-7045cf91.js" as="script"><link rel="prefetch" href="/assets/index.html-82e85232.js" as="script"><link rel="prefetch" href="/assets/index.html-46b70d01.js" as="script"><link rel="prefetch" href="/assets/index.html-a6c441fe.js" as="script"><link rel="prefetch" href="/assets/index.html-38736ecd.js" as="script"><link rel="prefetch" href="/assets/index.html-3d160279.js" as="script"><link rel="prefetch" href="/assets/index.html-70184545.js" as="script"><link rel="prefetch" href="/assets/index.html-0d7f9c84.js" as="script"><link rel="prefetch" href="/assets/index.html-50ec0628.js" as="script"><link rel="prefetch" href="/assets/index.html-6647c88b.js" as="script"><link rel="prefetch" href="/assets/index.html-e5fca210.js" as="script"><link rel="prefetch" href="/assets/index.html-4622c4d0.js" as="script"><link rel="prefetch" href="/assets/index.html-0aa16773.js" as="script"><link rel="prefetch" href="/assets/index.html-bcad5cb1.js" as="script"><link rel="prefetch" href="/assets/index.html-63434f2e.js" as="script"><link rel="prefetch" href="/assets/00.高性能MySQL-MySQL架构.html-6d7f7e17.js" as="script"><link rel="prefetch" href="/assets/index.html-9c62895c.js" as="script"><link rel="prefetch" href="/assets/index.html-aa30bf04.js" as="script"><link rel="prefetch" href="/assets/index.html-18f91996.js" as="script"><link rel="prefetch" href="/assets/index.html-d4863e55.js" as="script"><link rel="prefetch" href="/assets/index.html-546eb3a2.js" as="script"><link rel="prefetch" href="/assets/06.MySQL事务原理与优化最佳实践.html-0e42a487.js" as="script"><link rel="prefetch" href="/assets/index.html-53d3a5ee.js" as="script"><link rel="prefetch" href="/assets/index.html-2ee74260.js" as="script"><link rel="prefetch" href="/assets/index.html-1f029277.js" as="script"><link rel="prefetch" href="/assets/index.html-c20a9e23.js" as="script"><link rel="prefetch" href="/assets/index.html-af52d031.js" as="script"><link rel="prefetch" href="/assets/index.html-9308d7ca.js" as="script"><link rel="prefetch" href="/assets/20.关系型数据库层面的高并发优化.html-610c7929.js" as="script"><link rel="prefetch" href="/assets/Sharding-JDBC分库分表应用实战.html-fe196458.js" as="script"><link rel="prefetch" href="/assets/index.html-645f2ddf.js" as="script"><link rel="prefetch" href="/assets/index.html-254985ce.js" as="script"><link rel="prefetch" href="/assets/index.html-a8a57423.js" as="script"><link rel="prefetch" href="/assets/index.html-60388c3a.js" as="script"><link rel="prefetch" href="/assets/index.html-159ca966.js" as="script"><link rel="prefetch" href="/assets/index.html-d1e1f170.js" as="script"><link rel="prefetch" href="/assets/10.ShardingJDBC分库分表实战指南.html-fbff4896.js" as="script"><link rel="prefetch" href="/assets/20.ShardingJDBC源码与内核解析.html-1d5254a6.js" as="script"><link rel="prefetch" href="/assets/index.html-8e0ddc23.js" as="script"><link rel="prefetch" href="/assets/index.html-ad1ece24.js" as="script"><link rel="prefetch" href="/assets/index.html-fb73493c.js" as="script"><link rel="prefetch" href="/assets/index.html-128d4b71.js" as="script"><link rel="prefetch" href="/assets/index.html-d9f15724.js" as="script"><link rel="prefetch" href="/assets/index.html-72ba2d35.js" as="script"><link rel="prefetch" href="/assets/index.html-951dfe3f.js" as="script"><link rel="prefetch" href="/assets/index.html-c6d45626.js" as="script"><link rel="prefetch" href="/assets/index.html-263f14aa.js" as="script"><link rel="prefetch" href="/assets/index.html-768ded15.js" as="script"><link rel="prefetch" href="/assets/index.html-25fcc8f6.js" as="script"><link rel="prefetch" href="/assets/index.html-f0d68cb4.js" as="script"><link rel="prefetch" href="/assets/index.html-fbc23d80.js" as="script"><link rel="prefetch" href="/assets/index.html-cd6512b5.js" as="script"><link rel="prefetch" href="/assets/index.html-0df55126.js" as="script"><link rel="prefetch" href="/assets/index.html-ee2ee741.js" as="script"><link rel="prefetch" href="/assets/index.html-0cefaac0.js" as="script"><link rel="prefetch" href="/assets/Seata事务模式.html-c1a2d7b8.js" as="script"><link rel="prefetch" href="/assets/分布式事务组件Seata.html-1dd75d49.js" as="script"><link rel="prefetch" href="/assets/index.html-e60f4990.js" as="script"><link rel="prefetch" href="/assets/index.html-775dacd4.js" as="script"><link rel="prefetch" href="/assets/index.html-d478e84e.js" as="script"><link rel="prefetch" href="/assets/index.html-2c89d1e5.js" as="script"><link rel="prefetch" href="/assets/index.html-22f6ba4c.js" as="script"><link rel="prefetch" href="/assets/index.html-8d73c7f5.js" as="script"><link rel="prefetch" href="/assets/index.html-1534c5b2.js" as="script"><link rel="prefetch" href="/assets/index.html-7c9f70b1.js" as="script"><link rel="prefetch" href="/assets/index.html-8129550b.js" as="script"><link rel="prefetch" href="/assets/index.html-e6f50774.js" as="script"><link rel="prefetch" href="/assets/02.RocketMQ开发模型与生产环境问题剖析.html-eb0655fe.js" as="script"><link rel="prefetch" href="/assets/404.html-f4f9fdbe.js" as="script"><link rel="prefetch" href="/assets/index.html-ccedd87a.js" as="script"><link rel="prefetch" href="/assets/index.html-6b635626.js" as="script"><link rel="prefetch" href="/assets/index.html-0d639806.js" as="script"><link rel="prefetch" href="/assets/index.html-19b5aac4.js" as="script"><link rel="prefetch" href="/assets/index.html-f3c1ea90.js" as="script"><link rel="prefetch" href="/assets/index.html-e4505c26.js" as="script"><link rel="prefetch" href="/assets/index.html-c67c6358.js" as="script"><link rel="prefetch" href="/assets/index.html-08bdbe35.js" as="script"><link rel="prefetch" href="/assets/index.html-39a19522.js" as="script"><link rel="prefetch" href="/assets/index.html-4e6ecfce.js" as="script"><link rel="prefetch" href="/assets/index.html-c37db087.js" as="script"><link rel="prefetch" href="/assets/index.html-7f2f880b.js" as="script"><link rel="prefetch" href="/assets/index.html-f8546af5.js" as="script"><link rel="prefetch" href="/assets/index.html-36e6cb8c.js" as="script"><link rel="prefetch" href="/assets/index.html-27371869.js" as="script"><link rel="prefetch" href="/assets/index.html-4c15c6fc.js" as="script"><link rel="prefetch" href="/assets/index.html-116aca17.js" as="script"><link rel="prefetch" href="/assets/index.html-2a643c60.js" as="script"><link rel="prefetch" href="/assets/index.html-21236a9b.js" as="script"><link rel="prefetch" href="/assets/index.html-b238d9f4.js" as="script"><link rel="prefetch" href="/assets/index.html-46e55ee3.js" as="script"><link rel="prefetch" href="/assets/index.html-6d53c5d1.js" as="script"><link rel="prefetch" href="/assets/index.html-778d883e.js" as="script"><link rel="prefetch" href="/assets/index.html-d798a209.js" as="script"><link rel="prefetch" href="/assets/index.html-ab8b6fb7.js" as="script"><link rel="prefetch" href="/assets/index.html-200c9b62.js" as="script"><link rel="prefetch" href="/assets/index.html-d67216d5.js" as="script"><link rel="prefetch" href="/assets/index.html-9fa57983.js" as="script"><link rel="prefetch" href="/assets/index.html-2a6dfb95.js" as="script"><link rel="prefetch" href="/assets/index.html-30ef2e2b.js" as="script"><link rel="prefetch" href="/assets/index.html-2be3f4a2.js" as="script"><link rel="prefetch" href="/assets/index.html-4b04c8af.js" as="script"><link rel="prefetch" href="/assets/index.html-f3f33451.js" as="script"><link rel="prefetch" href="/assets/index.html-940c35a3.js" as="script"><link rel="prefetch" href="/assets/index.html-3fd779a7.js" as="script"><link rel="prefetch" href="/assets/index.html-1a8f23e9.js" as="script"><link rel="prefetch" href="/assets/index.html-0118c6d9.js" as="script"><link rel="prefetch" href="/assets/index.html-942ff972.js" as="script"><link rel="prefetch" href="/assets/index.html-41b511cf.js" as="script"><link rel="prefetch" href="/assets/index.html-c93e5cd2.js" as="script"><link rel="prefetch" href="/assets/index.html-6508b456.js" as="script"><link rel="prefetch" href="/assets/index.html-ed0506a1.js" as="script"><link rel="prefetch" href="/assets/index.html-d92890df.js" as="script"><link rel="prefetch" href="/assets/index.html-b2b41008.js" as="script"><link rel="prefetch" href="/assets/index.html-ac4c44c1.js" as="script"><link rel="prefetch" href="/assets/index.html-0ef231d8.js" as="script"><link rel="prefetch" href="/assets/intro.html-e7428ff2.js" as="script"><link rel="prefetch" href="/assets/index.html-b9556fc8.js" as="script"><link rel="prefetch" href="/assets/slides.html-eab48236.js" as="script"><link rel="prefetch" href="/assets/index.html-665afd14.js" as="script"><link rel="prefetch" href="/assets/index.html-f83f9993.js" as="script"><link rel="prefetch" href="/assets/index.html-56978f7b.js" as="script"><link rel="prefetch" href="/assets/04-Spring之Bean生命周期源码解析上.html-b7247965.js" as="script"><link rel="prefetch" href="/assets/index.html-8cc559be.js" as="script"><link rel="prefetch" href="/assets/index.html-a7dd8fd8.js" as="script"><link rel="prefetch" href="/assets/index.html-3a98d1c4.js" as="script"><link rel="prefetch" href="/assets/index.html-d73a1525.js" as="script"><link rel="prefetch" href="/assets/index.html-5318c4d7.js" as="script"><link rel="prefetch" href="/assets/index.html-457ce9e7.js" as="script"><link rel="prefetch" href="/assets/index.html-fdd8356b.js" as="script"><link rel="prefetch" href="/assets/index.html-e0d66afa.js" as="script"><link rel="prefetch" href="/assets/index.html-4e2bbab4.js" as="script"><link rel="prefetch" href="/assets/index.html-d910f15a.js" as="script"><link rel="prefetch" href="/assets/index.html-9561ff1d.js" as="script"><link rel="prefetch" href="/assets/index.html-30f80999.js" as="script"><link rel="prefetch" href="/assets/index.html-9dcbc31f.js" as="script"><link rel="prefetch" href="/assets/index.html-2aaba023.js" as="script"><link rel="prefetch" href="/assets/index.html-56beecf2.js" as="script"><link rel="prefetch" href="/assets/index.html-4ac77b65.js" as="script"><link rel="prefetch" href="/assets/index.html-04680db9.js" as="script"><link rel="prefetch" href="/assets/index.html-b84485e7.js" as="script"><link rel="prefetch" href="/assets/index.html-13e05219.js" as="script"><link rel="prefetch" href="/assets/index.html-d555ed94.js" as="script"><link rel="prefetch" href="/assets/00.站在全局视角理解系统高并发.html-c582b4ed.js" as="script"><link rel="prefetch" href="/assets/index.html-117a8cc9.js" as="script"><link rel="prefetch" href="/assets/10.BIO NIO编程与直接内存零拷贝.html-dff5b870.js" as="script"><link rel="prefetch" href="/assets/index.html-419bc6bd.js" as="script"><link rel="prefetch" href="/assets/index.html-0e274601.js" as="script"><link rel="prefetch" href="/assets/index.html-ac9e6eb3.js" as="script"><link rel="prefetch" href="/assets/100.高并发缓存实战.html-bb3dca4e.js" as="script"><link rel="prefetch" href="/assets/index.html-e8d1cd6b.js" as="script"><link rel="prefetch" href="/assets/30.微服务架构拆分实战.html-464c7c8a.js" as="script"><link rel="prefetch" href="/assets/index.html-9eb9424d.js" as="script"><link rel="prefetch" href="/assets/50.微服务网关整合OAuth2.0授权中心.html-65ba9822.js" as="script"><link rel="prefetch" href="/assets/index.html-45d4c581.js" as="script"><link rel="prefetch" href="/assets/index.html-b2cad19a.js" as="script"><link rel="prefetch" href="/assets/index.html-b445b218.js" as="script"><link rel="prefetch" href="/assets/index.html-38eb336b.js" as="script"><link rel="prefetch" href="/assets/工厂模式.html-25c7fcbc.js" as="script"><link rel="prefetch" href="/assets/建造模式.html-6a394885.js" as="script"><link rel="prefetch" href="/assets/index.html-383d6ee9.js" as="script"><link rel="prefetch" href="/assets/index.html-438346eb.js" as="script"><link rel="prefetch" href="/assets/index.html-15195453.js" as="script"><link rel="prefetch" href="/assets/index.html-c658f99c.js" as="script"><link rel="prefetch" href="/assets/index.html-1f92e072.js" as="script"><link rel="prefetch" href="/assets/index.html-f8c6ac49.js" as="script"><link rel="prefetch" href="/assets/index.html-a3f43e72.js" as="script"><link rel="prefetch" href="/assets/index.html-3a254eea.js" as="script"><link rel="prefetch" href="/assets/index.html-c5c6650c.js" as="script"><link rel="prefetch" href="/assets/index.html-23f096ab.js" as="script"><link rel="prefetch" href="/assets/index.html-5ebaadcf.js" as="script"><link rel="prefetch" href="/assets/index.html-b2773566.js" as="script"><link rel="prefetch" href="/assets/index.html-6cbf478d.js" as="script"><link rel="prefetch" href="/assets/index.html-e831014e.js" as="script"><link rel="prefetch" href="/assets/index.html-785ed7bb.js" as="script"><link rel="prefetch" href="/assets/index.html-f3e74dfc.js" as="script"><link rel="prefetch" href="/assets/index.html-f81d62bb.js" as="script"><link rel="prefetch" href="/assets/index.html-8ad8341a.js" as="script"><link rel="prefetch" href="/assets/index.html-a79cad4a.js" as="script"><link rel="prefetch" href="/assets/index.html-47595303.js" as="script"><link rel="prefetch" href="/assets/index.html-b480d9bc.js" as="script"><link rel="prefetch" href="/assets/index.html-a92c053c.js" as="script"><link rel="prefetch" href="/assets/index.html-bfc04686.js" as="script"><link rel="prefetch" href="/assets/index.html-9d3fe728.js" as="script"><link rel="prefetch" href="/assets/index.html-47cf51fb.js" as="script"><link rel="prefetch" href="/assets/index.html-ac350db2.js" as="script"><link rel="prefetch" href="/assets/index.html-4c6cd4a4.js" as="script"><link rel="prefetch" href="/assets/index.html-911b3838.js" as="script"><link rel="prefetch" href="/assets/index.html-69be0725.js" as="script"><link rel="prefetch" href="/assets/index.html-23073987.js" as="script"><link rel="prefetch" href="/assets/index.html-bc49fd05.js" as="script"><link rel="prefetch" href="/assets/index.html-b96ee357.js" as="script"><link rel="prefetch" href="/assets/index.html-7a9bcddf.js" as="script"><link rel="prefetch" href="/assets/index.html-4a3838c4.js" as="script"><link rel="prefetch" href="/assets/index.html-a8d05a68.js" as="script"><link rel="prefetch" href="/assets/index.html-efbe38da.js" as="script"><link rel="prefetch" href="/assets/index.html-dc25f82d.js" as="script"><link rel="prefetch" href="/assets/00.高性能MySQL-MySQL架构.html-7427ff15.js" as="script"><link rel="prefetch" href="/assets/index.html-ad6497af.js" as="script"><link rel="prefetch" href="/assets/index.html-e902ce98.js" as="script"><link rel="prefetch" href="/assets/index.html-d2b23147.js" as="script"><link rel="prefetch" href="/assets/index.html-83b4d8ba.js" as="script"><link rel="prefetch" href="/assets/index.html-a8530f1e.js" as="script"><link rel="prefetch" href="/assets/06.MySQL事务原理与优化最佳实践.html-adb3aaea.js" as="script"><link rel="prefetch" href="/assets/index.html-e9c9a57e.js" as="script"><link rel="prefetch" href="/assets/index.html-1a4efafa.js" as="script"><link rel="prefetch" href="/assets/index.html-586e29b9.js" as="script"><link rel="prefetch" href="/assets/index.html-d7b366a1.js" as="script"><link rel="prefetch" href="/assets/index.html-b8f399a3.js" as="script"><link rel="prefetch" href="/assets/index.html-c3bf8003.js" as="script"><link rel="prefetch" href="/assets/20.关系型数据库层面的高并发优化.html-d4d5b2b5.js" as="script"><link rel="prefetch" href="/assets/Sharding-JDBC分库分表应用实战.html-21cd0604.js" as="script"><link rel="prefetch" href="/assets/index.html-77d9b9b3.js" as="script"><link rel="prefetch" href="/assets/index.html-1e755c68.js" as="script"><link rel="prefetch" href="/assets/index.html-cbf299b0.js" as="script"><link rel="prefetch" href="/assets/index.html-c00cf0ce.js" as="script"><link rel="prefetch" href="/assets/index.html-e66b6beb.js" as="script"><link rel="prefetch" href="/assets/index.html-df52a6c0.js" as="script"><link rel="prefetch" href="/assets/10.ShardingJDBC分库分表实战指南.html-31c4b2b5.js" as="script"><link rel="prefetch" href="/assets/20.ShardingJDBC源码与内核解析.html-e7a27975.js" as="script"><link rel="prefetch" href="/assets/index.html-af76769c.js" as="script"><link rel="prefetch" href="/assets/index.html-707342c5.js" as="script"><link rel="prefetch" href="/assets/index.html-c3af8924.js" as="script"><link rel="prefetch" href="/assets/index.html-5a24cd56.js" as="script"><link rel="prefetch" href="/assets/index.html-f7fc1f1a.js" as="script"><link rel="prefetch" href="/assets/index.html-9175bdcf.js" as="script"><link rel="prefetch" href="/assets/index.html-51103a80.js" as="script"><link rel="prefetch" href="/assets/index.html-9829f24a.js" as="script"><link rel="prefetch" href="/assets/index.html-c2c7c44a.js" as="script"><link rel="prefetch" href="/assets/index.html-394e244d.js" as="script"><link rel="prefetch" href="/assets/index.html-7047881d.js" as="script"><link rel="prefetch" href="/assets/index.html-cba9b20c.js" as="script"><link rel="prefetch" href="/assets/index.html-99225007.js" as="script"><link rel="prefetch" href="/assets/index.html-29dc177e.js" as="script"><link rel="prefetch" href="/assets/index.html-a5e85ce7.js" as="script"><link rel="prefetch" href="/assets/index.html-abec4e92.js" as="script"><link rel="prefetch" href="/assets/index.html-68d56ed9.js" as="script"><link rel="prefetch" href="/assets/Seata事务模式.html-df1eb2a0.js" as="script"><link rel="prefetch" href="/assets/分布式事务组件Seata.html-cdc2e793.js" as="script"><link rel="prefetch" href="/assets/index.html-1b562cc9.js" as="script"><link rel="prefetch" href="/assets/index.html-4fa6e20b.js" as="script"><link rel="prefetch" href="/assets/index.html-a522e76b.js" as="script"><link rel="prefetch" href="/assets/index.html-4decfe2a.js" as="script"><link rel="prefetch" href="/assets/index.html-c89e916d.js" as="script"><link rel="prefetch" href="/assets/index.html-aa43cae4.js" as="script"><link rel="prefetch" href="/assets/index.html-220b0632.js" as="script"><link rel="prefetch" href="/assets/index.html-32ecb0a8.js" as="script"><link rel="prefetch" href="/assets/index.html-15509799.js" as="script"><link rel="prefetch" href="/assets/index.html-8fe3446c.js" as="script"><link rel="prefetch" href="/assets/02.RocketMQ开发模型与生产环境问题剖析.html-f7418d44.js" as="script"><link rel="prefetch" href="/assets/404.html-23fe042b.js" as="script"><link rel="prefetch" href="/assets/index.html-bee8e10a.js" as="script"><link rel="prefetch" href="/assets/index.html-c6bddc61.js" as="script"><link rel="prefetch" href="/assets/index.html-69a53714.js" as="script"><link rel="prefetch" href="/assets/index.html-d3c81ef8.js" as="script"><link rel="prefetch" href="/assets/index.html-a652e14a.js" as="script"><link rel="prefetch" href="/assets/index.html-c4e39ae4.js" as="script"><link rel="prefetch" href="/assets/index.html-731c07f8.js" as="script"><link rel="prefetch" href="/assets/index.html-e3e9f7ac.js" as="script"><link rel="prefetch" href="/assets/index.html-0427bad4.js" as="script"><link rel="prefetch" href="/assets/index.html-e46d04b7.js" as="script"><link rel="prefetch" href="/assets/index.html-1a6f4236.js" as="script"><link rel="prefetch" href="/assets/index.html-6bf4332d.js" as="script"><link rel="prefetch" href="/assets/index.html-aae387cc.js" as="script"><link rel="prefetch" href="/assets/index.html-b76a362c.js" as="script"><link rel="prefetch" href="/assets/index.html-3854a209.js" as="script"><link rel="prefetch" href="/assets/index.html-96cf762e.js" as="script"><link rel="prefetch" href="/assets/index.html-4eb91ff5.js" as="script"><link rel="prefetch" href="/assets/index.html-5784bcd9.js" as="script"><link rel="prefetch" href="/assets/index.html-90ebbb17.js" as="script"><link rel="prefetch" href="/assets/index.html-f33a1fe5.js" as="script"><link rel="prefetch" href="/assets/index.html-d8e1124b.js" as="script"><link rel="prefetch" href="/assets/index.html-27e27972.js" as="script"><link rel="prefetch" href="/assets/index.html-5180dca2.js" as="script"><link rel="prefetch" href="/assets/index.html-3c161dff.js" as="script"><link rel="prefetch" href="/assets/index.html-3afcabaf.js" as="script"><link rel="prefetch" href="/assets/index.html-078dd1cb.js" as="script"><link rel="prefetch" href="/assets/index.html-cb063f71.js" as="script"><link rel="prefetch" href="/assets/index.html-7ea20f90.js" as="script"><link rel="prefetch" href="/assets/index.html-14a634b9.js" as="script"><link rel="prefetch" href="/assets/index.html-bc140489.js" as="script"><link rel="prefetch" href="/assets/index.html-c1718895.js" as="script"><link rel="prefetch" href="/assets/index.html-11d1f9e0.js" as="script"><link rel="prefetch" href="/assets/index.html-503c7ff1.js" as="script"><link rel="prefetch" href="/assets/index.html-0bff167b.js" as="script"><link rel="prefetch" href="/assets/index.html-3180bf73.js" as="script"><link rel="prefetch" href="/assets/index.html-547654c9.js" as="script"><link rel="prefetch" href="/assets/index.html-03c68b8c.js" as="script"><link rel="prefetch" href="/assets/index.html-2fbd4b34.js" as="script"><link rel="prefetch" href="/assets/index.html-aa3eb555.js" as="script"><link rel="prefetch" href="/assets/index.html-b1dc3146.js" as="script"><link rel="prefetch" href="/assets/index.html-3f92a9e4.js" as="script"><link rel="prefetch" href="/assets/index.html-db96decf.js" as="script"><link rel="prefetch" href="/assets/index.html-7c1c02d3.js" as="script"><link rel="prefetch" href="/assets/index.html-0ed8546c.js" as="script"><link rel="prefetch" href="/assets/index.html-f8450136.js" as="script"><link rel="prefetch" href="/assets/index.html-e37a870c.js" as="script"><link rel="prefetch" href="/assets/giscus-52604b1e.js" as="script"><link rel="prefetch" href="/assets/auto-fa8841cf.js" as="script"><link rel="prefetch" href="/assets/index-ae8c1e74.js" as="script"><link rel="prefetch" href="/assets/flowchart-d65a1d8e.js" as="script"><link rel="prefetch" href="/assets/mermaid.core-326ca727.js" as="script"><link rel="prefetch" href="/assets/highlight.esm-75b11b9d.js" as="script"><link rel="prefetch" href="/assets/markdown.esm-0191f9da.js" as="script"><link rel="prefetch" href="/assets/math.esm-70a288c8.js" as="script"><link rel="prefetch" href="/assets/notes.esm-a106bb2c.js" as="script"><link rel="prefetch" href="/assets/reveal.esm-ec5549c1.js" as="script"><link rel="prefetch" href="/assets/search.esm-7e6792e2.js" as="script"><link rel="prefetch" href="/assets/zoom.esm-b83b91d0.js" as="script"><link rel="prefetch" href="/assets/VuePlayground-258a50e0.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-2450701e.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container no-sidebar has-toc"><!--[--><header class="navbar" id="navbar"><div class="navbar-start"><button type="button" class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a href="/" class="brand"><img class="logo" src="/logo.svg" alt="学习笔记"><!----><span class="site-name hide-in-pad">学习笔记</span></a><!--]--><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><!--[--><!----><!--]--><!--[--><!----><!--]--></div><div class="navbar-end"><!--[--><!----><!--]--><!--[--><!----><!----><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!----><!--]--><!--[--><!----><!--]--><button type="button" class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside class="sidebar" id="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->RocketMQ快速实战以及集群架构解析</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">江</span></span><span property="author" content="江"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2022-11-13T13:46:11.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 31 分钟</span><meta property="timeRequired" content="PT31M"></span><span class="page-category-info" aria-label="分类🌈" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item category8 clickable" role="navigation">消息队列</span><span class="page-category-item category0 clickable" role="navigation">RocketMQ</span><!--]--><meta property="articleSection" content="消息队列,RocketMQ"></span><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">此页内容<button type="button" class="print-button" title="打印"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#rocketmq介绍" class="router-link-active router-link-exact-active toc-link level2">RocketMQ介绍</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#rocketmq的发展历程" class="router-link-active router-link-exact-active toc-link level3">RocketMQ的发展历程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#rocketmq产品特点比较" class="router-link-active router-link-exact-active toc-link level3">RocketMQ产品特点比较</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#rocketmq快速实战" class="router-link-active router-link-exact-active toc-link level2">RocketMQ快速实战</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#下载rocketmq" class="router-link-active router-link-exact-active toc-link level3">下载RocketMQ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#快速安装rocketmq" class="router-link-active router-link-exact-active toc-link level3">快速安装RocketMQ</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#快速运行rocketmq" class="router-link-active router-link-exact-active toc-link level3">快速运行RocketMQ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#rocketmq集群架构" class="router-link-active router-link-exact-active toc-link level2">RocketMQ集群架构</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#rocketmq集群架构解析" class="router-link-active router-link-exact-active toc-link level3">RocketMQ集群架构解析</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#rocketmq集群搭建与优化" class="router-link-active router-link-exact-active toc-link level3">RocketMQ集群搭建与优化</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#rocketmq消息转发模型" class="router-link-active router-link-exact-active toc-link level2">RocketMQ消息转发模型</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#消息模型-message-model" class="router-link-active router-link-exact-active toc-link level3">消息模型（Message Model）</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#消息生产者-producer" class="router-link-active router-link-exact-active toc-link level3">消息生产者（Producer）</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#消息消费者-consumer" class="router-link-active router-link-exact-active toc-link level3">消息消费者（Consumer）</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#主题-topic" class="router-link-active router-link-exact-active toc-link level3">主题（Topic）</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#代理服务器-broker-server" class="router-link-active router-link-exact-active toc-link level3">代理服务器（Broker Server）</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#名字服务-name-server" class="router-link-active router-link-exact-active toc-link level3">名字服务（Name Server）</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/pages/f720d9/#消息-message" class="router-link-active router-link-exact-active toc-link level3">消息（Message）</a></li><!----><!--]--></ul></li><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!----><div class="theme-hope-content"><h2 id="rocketmq介绍" tabindex="-1"><a class="header-anchor" href="#rocketmq介绍" aria-hidden="true">#</a> RocketMQ介绍</h2><p>​ RocketMQ是阿里巴巴开源的一个消息中间件，在阿里内部历经了双十一等很多高并发场景的考验，能够处理亿万级别的消息。2016年开源后捐赠给Apache，现在是Apache的一个顶级项目。</p><p>​ 目前RocketMQ在阿里云上有一个购买即可用的商业版本，商业版本集成了阿里内部一些更深层次的功能及运维定制。我们这里学习的是Apache的开源版本。开源版本相对于阿里云上的商业版本，功能上略有缺失，但是大体上功能是一样的。</p><h3 id="rocketmq的发展历程" tabindex="-1"><a class="header-anchor" href="#rocketmq的发展历程" aria-hidden="true">#</a> RocketMQ的发展历程</h3><p>​ 早期阿里使用ActiveMQ，但是，当消息开始逐渐增多后，ActiveMQ的IO性能很快达到了瓶颈。于是，阿里开始关注Kafka。但是Kafka是针对日志收集场景设计的，他的并发性能并不是很理想。尤其当他的Topic过多时，由于Partition文件也会过多，会严重影响IO性能。于是阿里才决定自研中间件，最早叫做MetaQ，后来改名成为RocketMQ。最早他所希望解决的最大问题就是多Topic下的IO性能压力。但是产品在阿里内部的不断改进，RocketMQ开始体现出一些不一样的优势。</p><h3 id="rocketmq产品特点比较" tabindex="-1"><a class="header-anchor" href="#rocketmq产品特点比较" aria-hidden="true">#</a> RocketMQ产品特点比较</h3><p>​ RocketMQ的消息吞吐量虽然依然不如Kafka，但是却比RabbitMQ高很多。在阿里内部，RocketMQ集群每天处理的请求数超过5万亿次，支持的核心应用超过3000个。</p><p>​ RocketMQ天生就为金融互联网而生，因此他的消息可靠性相比Kafka也有了很大的提升，而消息吞吐量相比RabbitMQ也有很大的提升。另外，RocketMQ的高级功能也越来越全面，广播消费、延迟队列、死信队列等等高级功能一应俱全，甚至某些业务功能比如事务消息，已经呈现出领先潮流的趋势。</p><p>​ RocketMQ的源码是用Java开发的，这也使得很多互联网公司可以根据自己的业务需求做深度定制。而RocketMQ经过阿里双十一多次考验，源码的稳定性是值得信赖的，这使得功能定制有一个非常高的起点。</p><p>​ 传统意义上，RocketMQ有一个比较大的局限，就是他的客户端只支持Java语言。但RocketMQ作为一个开源软件，自身产品不断成熟的同时，周边的技术生态也需要不断演进。RocketMQ成为Apache顶级项目后，又继续通过社区开发出了很多与主流技术生态融合的周边产品。例如在RocketMQ的社区，也正在开发GO，Python，Nodejs等语言的客户端。下图列出了RocketMQ社区目前的一些项目</p><figure><img src="https://img.jssjqd.cn/202211131351558.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h2 id="rocketmq快速实战" tabindex="-1"><a class="header-anchor" href="#rocketmq快速实战" aria-hidden="true">#</a> RocketMQ快速实战</h2><p>​ RocketMQ的官网地址： <a href="http://rocketmq.apache.org" target="_blank" rel="noopener noreferrer">http://rocketmq.apache.org<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ，github地址是 <a href="https://github.com/apache/rocketmq" target="_blank" rel="noopener noreferrer">https://github.com/apache/rocketmq<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> ，当前最新的版本是4.9.3。我们这次采用4.9.1版本来学习</p><h3 id="下载rocketmq" tabindex="-1"><a class="header-anchor" href="#下载rocketmq" aria-hidden="true">#</a> 下载RocketMQ</h3><p>​ 最新版本的RocketMQ可以到官网上进行下载。历史版本需要到Github仓库中下载。下载地址：<a href="https://github.com/apache/rocketmq/releases%E3%80%82" target="_blank" rel="noopener noreferrer">https://github.com/apache/rocketmq/releases。<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>​ 目前RocketMQ的历史运行版本已经无法在官网下载，只能通过Github仓库下载历史版本的源码，自行编译。配套资料中提供了4.9.1版本的运行版本以及源码。</p><h3 id="快速安装rocketmq" tabindex="-1"><a class="header-anchor" href="#快速安装rocketmq" aria-hidden="true">#</a> 快速安装RocketMQ</h3><p>​ RocketMQ的安装非常简单，就是上传解压就可以了。</p><p>​ 然后我们准备一台CentOS7的Linux机器，快速把RocketMQ给运行起来。我使用的Linux版本如下：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>oper@worker1 jdk1.8<span class="token punctuation">]</span>$ <span class="token function">uname</span> <span class="token parameter variable">-a</span>
Linux worker1 <span class="token number">3.10</span>.0-1127.el7.x86_64 <span class="token comment">#1 SMP Tue Mar 31 23:36:51 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>​ 我们需要创建一个操作用户用来运行自己的程序，与root用户区分开。使用root用户创建一个oper用户，并给他创建一个工作目录。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>root@worker1 ~<span class="token punctuation">]</span><span class="token comment"># useradd oper</span>
<span class="token punctuation">[</span>root@worker1 ~<span class="token punctuation">]</span><span class="token comment"># passwd oper </span>
设置用户密码
<span class="token punctuation">[</span>root@worker1 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /app</span>
<span class="token punctuation">[</span>root@worker1 ~<span class="token punctuation">]</span><span class="token comment"># chown oper:oper /app</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​ 运行RocketMQ需要先安装JDK。我们采用目前最稳定的JDK1.8版本。CentOS可以采用课件资料中的jdk-8u171-linux-x64.tar.gz，也可以自行去Oracle官网上下载。然后用FTP上传到oper用户的工作目录下。由oper用户解压到/app/jdk1.8目录下。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>[oper@worker1 tools]$ tar -zxvf jdk-8u171-linux-x64.tar.gz
[oper@worker1 tools]$ mv jdk1.8.0_171/ /app/jdk1.8
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>​ 配置环境变量。使用 vi ~/.bash_profile编辑文件，在下面加入以下内容：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/app/jdk1.8/
<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token environment constant">$HOME</span>/.local/bin:<span class="token environment constant">$HOME</span>/bin
<span class="token builtin class-name">export</span> <span class="token environment constant">PATH</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​ 编辑完成后，执行 source ~/.bash_profile让环境变量生效。输入java -version能查看到以下内容表明JDK安装成功了。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token punctuation">[</span>oper@worker1 ~<span class="token punctuation">]</span>$ <span class="token function">java</span> <span class="token parameter variable">-version</span>
<span class="token function">java</span> version <span class="token string">&quot;1.8.0_171&quot;</span>
Java<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> SE Runtime Envirx onment <span class="token punctuation">(</span>build <span class="token number">1.8</span>.0_171-b11<span class="token punctuation">)</span>
Java HotSpot<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> <span class="token number">64</span>-Bit Server VM <span class="token punctuation">(</span>build <span class="token number">25.171</span>-b11, mixed mode<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​ 然后我们把下载的rocketmq-all-4.9.1-bin-release.zip在本地完成解压，并上传到/app/rocketmq目录。完成后，把rocketmq的bin目录也配置到环境变量当中。 vi ~/.bash_profile，加入以下内容，并执行source ~/.bash_profile让环境变量生效：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/app/jdk1.8/
<span class="token builtin class-name">export</span> <span class="token assign-left variable">ROCKETMQ_HOME</span><span class="token operator">=</span>/app/rocketmq/rocketmq-all-4.9.1-bin-release
<span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">$ROCKETMQ_HOME</span>/bin:<span class="token variable">$JAVA_HOME</span>/bin:<span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token environment constant">$HOME</span>/.local/bin:<span class="token environment constant">$HOME</span>/bin
<span class="token builtin class-name">export</span> <span class="token environment constant">PATH</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​ 这样RocketMQ就安装完成了。我们把他运行起来。</p><blockquote><p>这个ROCKETMQ_HOME的环境变量是必须要单独配置的，如果不配置的话，启动NameSever和Broker都会报错。</p><p>这个环境变量的作用是用来加载$ROCKETMQ_HOME/conf下的除broker.conf以外的几个配置文件。所以实际情况中，可以不按这个配置，但是一定要能找到配置文件。</p></blockquote><h3 id="快速运行rocketmq" tabindex="-1"><a class="header-anchor" href="#快速运行rocketmq" aria-hidden="true">#</a> 快速运行RocketMQ</h3><h4 id="rocketmq工作原理" tabindex="-1"><a class="header-anchor" href="#rocketmq工作原理" aria-hidden="true">#</a> RocketMQ工作原理</h4><p>​ 运行之前，我们需要对RocketMQ的组件结构有个大致的了解。</p><figure><img src="https://img.jssjqd.cn/202211131351686.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>​ RocketMQ由以下这几个组件组成</p><ul><li>NameServer : 提供轻量级的Broker路由服务。</li><li>Broker：实际处理消息存储、转发等服务的核心组件。</li><li>Producer：消息生产者集群。通常是业务系统中的一个功能模块。</li><li>Consumer：消息消费者集群。通常也是业务系统中的一个功能模块。</li></ul><p>所以我们要启动RocketMQ服务，需要先启动NameServer。</p><h4 id="nameserver服务搭建" tabindex="-1"><a class="header-anchor" href="#nameserver服务搭建" aria-hidden="true">#</a> NameServer服务搭建</h4><p>​ 启动NameServer非常简单， 在$ROCKETMQ_HOME/bin目录下有个mqadminsrv。直接执行这个脚本就可以启动RocketMQ的NameServer服务。</p><p>​ 但是要注意，RocketMQ默认预设的JVM内存是4G，这是RocketMQ给我们的最佳配置。但是通常我们用虚拟机的话都是不够4G内存的，所以需要调整下JVM内存大小。<a href="http://xn--runserver-z89na9857bcqmtlfda85rmzcf95l5zb.sh" target="_blank" rel="noopener noreferrer">修改的方式是直接修改runserver.sh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。 用vi runserver.sh编辑这个脚本，在脚本中找到这一行调整内存大小为512M</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">JAVA_OPT</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${JAVA_OPT}</span> -server -Xms512m -Xmx512m -Xmn256m -
XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>​ 然后我们用静默启动的方式启动NameServer服务：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">nohup</span> bin/mqnamesrv <span class="token operator">&amp;</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>​ 启动完成后，在nohup.out里看到这一条关键日志就是启动成功了。并且使用jps指令可以看到有一个NamesrvStartup进程。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Java HotSpot(TM) 64-Bit Server VM warning: Using the DefNew young collector with the CMS
collector is deprecated and will likely be removed in a future release
Java HotSpot(TM) 64-Bit Server VM warning: UseCMSCompactAtFullCollection is deprecated and
will likely be removed in a future release.
The Name Server boot success. serializeType=JSON
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="broker服务搭建" tabindex="-1"><a class="header-anchor" href="#broker服务搭建" aria-hidden="true">#</a> Broker服务搭建</h4><p>​ <a href="http://xn--Brokerrunbroker-wy8y53qb44gl6dtn1h9p4b.sh" target="_blank" rel="noopener noreferrer">启动Broker的脚本是runbroker.sh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>。Broker的默认预设内存是8G，启动前，如果内存不够，同样需要调整下JVM内存。vi <a href="http://runbroker.sh" target="_blank" rel="noopener noreferrer">runbroker.sh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，找到这一行，进行内存调整</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">JAVA_OPT</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${JAVA_OPT}</span> -server -Xms512m -Xmx512m&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>​ 然后我们需要找到$ROCKETMQ_HOME/conf/broker.conf， vi指令进行编辑，在最下面加入一个配置：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">autoCreateTopicEnable</span><span class="token operator">=</span>true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>​ <a href="http://xn--runbroker-zz6n89bg5xa221choab1448bmczanv9bfgw6s1niq8a.sh" target="_blank" rel="noopener noreferrer">然后也以静默启动的方式启动runbroker.sh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">nohup</span> ./mqbroker <span class="token operator">&amp;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>​ 启动完成后，同样是检查nohup.out日志，有这一条关键日志就标识启动成功了。 并且jps指令可以看到一个BrokerStartup进程。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>The broker[worker1, 192.168.232.128:10911] boot success. serializeType=JSON
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>在观察runserver.sh和runbroker.sh时，我们还可以查看到其他的JVM执行参数，这些参数都可以进行定制。例如我们观察到一个比较有意思的地方，nameServer使用的是CMS垃圾回收器，而Broker使用的是G1垃圾回收器。 关于垃圾回收器的知识你还记得吗？</p></blockquote><h4 id="命令行启动客户端" tabindex="-1"><a class="header-anchor" href="#命令行启动客户端" aria-hidden="true">#</a> 命令行启动客户端</h4><p>​ 在RocketMQ的安装包中，提供了一个tools.sh工具可以用来在命令行快速验证RocketMQ服务。我们在worker2上进入RocketMQ的安装目录：</p><p>首先需要配置一个环境变量NAMESRV_ADDR指向我们启动的NameServer服务。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">NAMESRV_ADDR</span><span class="token operator">=</span><span class="token string">&#39;localhost:9876&#39;</span>	
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后启动消息生产者发送消息：默认会发1000条消息</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>bin/tools.sh org.apache.rocketmq.example.quickstart.Producer
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>我们可以看到发送消息的日志：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>.....
SendResult [sendStatus=SEND_OK, msgId=C0A8E88007AC3764951D891CE9A003E7, offsetMsgId=C0A8E88000002A9F00000000000317BF, messageQueue=MessageQueue [topic=TopicTest, brokerName=worker1, queueId=1], queueOffset=249]
14:59:33.418 [NettyClientSelector_1] INFO  RocketmqRemoting - closeChannel: close the connection to remote address[127.0.0.1:9876] result: true
14:59:33.423 [NettyClientSelector_1] INFO  RocketmqRemoting - closeChannel: close the connection to remote address[192.168.232.128:10911] result: true
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这日志中，上面部分就是我们发送的消息的内容。后面两句标识消息生产者正常关闭。</p><p>然后启动消息消费者接收消息：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>bin/tools.sh  org.apache.rocketmq.example.quickstart.Consumer
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>启动后，可以看到消费到的消息。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>......
ConsumeMessageThread_19 Receive New Messages: [MessageExt [brokerName=worker1, queueId=2, storeSize=203, queueOffset=53, sysFlag=0, bornTimestamp=1606460371999, bornHost=/192.168.232.128:43436, storeTimestamp=1606460372000, storeHost=/192.168.232.128:10911, msgId=C0A8E88000002A9F000000000000A7AE, commitLogOffset=42926, bodyCRC=1968636794, reconsumeTimes=0, preparedTransactionOffset=0, toString()=Message{topic=&#39;TopicTest&#39;, flag=0, properties={MIN_OFFSET=0, MAX_OFFSET=250, CONSUME_START_TIME=1606460450150, UNIQ_KEY=C0A8E88007AC3764951D891CE41F00D4, CLUSTER=DefaultCluster, WAIT=true, TAGS=TagA}, body=[72, 101, 108, 108, 111, 32, 82, 111, 99, 107, 101, 116, 77, 81, 32, 50, 49, 50], transactionId=&#39;null&#39;}]] 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>日志中MessageExt后的整个内容就是一条完整的RocketMQ消息。我们要对这个消息的结构有个大概的了解，后面会对这个消息进行深入的理解。</p><p>其中比较关键的属性有：brokerName，queueId，msgId，topic，cluster，tags，body，transactionId。先找下这些属性在哪里。</p></blockquote><p>而这个Consume指令并不会结束，他会继续挂起，等待消费其他的消息。我们可以使用CTRL+C停止该进程。</p><h4 id="关闭rocketmq服务" tabindex="-1"><a class="header-anchor" href="#关闭rocketmq服务" aria-hidden="true">#</a> 关闭RocketMQ服务</h4><p>要关闭RocketMQ服务可以通过mqshutdown脚本直接关闭</p><div class="language-Shell line-numbers-mode" data-ext="Shell"><pre class="language-Shell"><code># 1.关闭NameServer
sh bin/mqshutdown namesrv
# 2.关闭Broker
sh bin/mqshutdown broker
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="rocketmq集群架构" tabindex="-1"><a class="header-anchor" href="#rocketmq集群架构" aria-hidden="true">#</a> RocketMQ集群架构</h2><p>​ 刚才的演示中，我们已经体验到了RocketMQ是如何工作的。这样，我们回头看RocketMQ的集群架构，就能够有更全面的理解了。</p><figure><img src="https://img.jssjqd.cn/202211131351468.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><h3 id="rocketmq集群架构解析" tabindex="-1"><a class="header-anchor" href="#rocketmq集群架构解析" aria-hidden="true">#</a> RocketMQ集群架构解析</h3><p>一个完整的RocketMQ集群中，有如下几个角色</p><ul><li>Producer：消息的发送者；举例：发信者</li><li>Consumer：消息接收者；举例：收信者</li><li>Broker：暂存和传输消息；举例：邮局</li><li>NameServer：管理Broker；举例：各个邮局的管理机构</li><li>Topic：区分消息的种类；一个发送者可以发送消息给一个或者多个Topic；一个消息的接收者可以订阅一个或者多个Topic消息</li></ul><blockquote><p>我们之前的测试案例中，Topic是什么？topic=&#39;TopicTest&#39;</p><p>现在你能看懂我们之前在broker.conf中添加的autoCreateTopicEnable=true这个属性的用处了吗？</p></blockquote><ul><li>Message Queue：相当于是Topic的分区；用于并行发送和接收消息</li></ul><blockquote><p>在我们之前的测试案例中，一个queueId就代表了一个MessageQueue。有哪些queueId？ 0，1，2，3四个MessageQueue，你都找到了吗？</p></blockquote><h3 id="rocketmq集群搭建与优化" tabindex="-1"><a class="header-anchor" href="#rocketmq集群搭建与优化" aria-hidden="true">#</a> RocketMQ集群搭建与优化</h3><h4 id="实验环境" tabindex="-1"><a class="header-anchor" href="#实验环境" aria-hidden="true">#</a> 实验环境</h4><p>​ 准备三台虚拟机，硬盘空间建议大于4G。配置机器名。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>#vi /etc/hosts
192.168.232.128 worker1
192.168.232.129 worker2
192.168.232.130 worker3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>以后我们更多的会关注机器名，而不会太多关注IP地址。</p></blockquote><h4 id="创建用户-可选" tabindex="-1"><a class="header-anchor" href="#创建用户-可选" aria-hidden="true">#</a> 创建用户--可选</h4><p>useradd oper</p><p>passwd oper (密码输入 123qweasd)</p><h4 id="系统配置" tabindex="-1"><a class="header-anchor" href="#系统配置" aria-hidden="true">#</a> 系统配置</h4><p><strong>免密登录</strong></p><p>切换oper用户，在worker1上 生成key</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>ssh-kengen
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后分发给其他机器</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>ssh-copy-id worker1
ssh-copy-id worker2
ssh-copy-id worker3
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样就可以在worker1上直接ssh 或者scp到另外的机器，不需要输密码了。</p><p><strong>关闭防火墙</strong></p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>systemctl stop firewalld.service
firewall-cmd <span class="token parameter variable">--state</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="安装jdk1-8-略" tabindex="-1"><a class="header-anchor" href="#安装jdk1-8-略" aria-hidden="true">#</a> 安装JDK1.8 - 略</h4><h4 id="安装rocketmq" tabindex="-1"><a class="header-anchor" href="#安装rocketmq" aria-hidden="true">#</a> 安装RocketMQ</h4><p>上传配套的运行包rocketmq-all-4.9.1-bin-release.zip，直接解压到/app/rocketmq目录。然后配置环境变量</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>export ROCKETMQ_HOME=/app/rocketmq/rocketmq-all-4.9.1-bin-release
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h4 id="配置rocketmq主从集群" tabindex="-1"><a class="header-anchor" href="#配置rocketmq主从集群" aria-hidden="true">#</a> 配置RocketMQ主从集群</h4><p>​ 我们为了便于观察，这次搭建一个2主2从异步刷盘的集群，所以我们会使用conf/2m-2s-async下的配置文件。预备设计的集群情况如下：</p><table><thead><tr><th>机器名</th><th>nemaeServer节点部署</th><th>broker节点部署</th></tr></thead><tbody><tr><td>worker1</td><td>nameserver</td><td></td></tr><tr><td>worker2</td><td>nameserver</td><td>broker-a, broker-b-s</td></tr><tr><td>worker3</td><td>nameserver</td><td>broker-b,broker-a-s</td></tr></tbody></table><p>所以修改的配置文件是进入rocketmq的config目录下修改2m-2s-async的配置文件。主要是配置broker.conf文件。</p><blockquote><p>在rocketmq的config目录下可以看到rocketmq建议的各种配置方式：</p><ul><li>2m-2s-async: 2主2从异步刷盘(吞吐量较大，但是消息可能丢失),</li><li>2m-2s-sync:2主2从同步刷盘(吞吐量会下降，但是消息更安全)，</li><li>2m-noslave:2主无从(单点故障)，然后还可以直接配置broker.conf，进行单点环境配置。</li><li>而dleger就是用来实现主从切换的。集群中的节点会基于Raft协议随机选举出一个leader，其他的就都是follower。通常正式环境都会采用这种方式来搭建集群。</li></ul></blockquote><p>我们这次采用2m-2s-async的方式搭建集群。</p><p><strong>1、配置第一组broker-a</strong></p><p>在<strong>worker2</strong>上先配置borker-a的master节点。先配置2m-2s-async/broker-a.properties</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#所属集群名字，名字一样的节点就在同一个集群内</span>
<span class="token key attr-name">brokerClusterName</span><span class="token punctuation">=</span><span class="token value attr-value">rocketmq-cluster</span>
<span class="token comment">#broker名字，名字一样的节点就是一组主从节点。</span>
<span class="token key attr-name">brokerName</span><span class="token punctuation">=</span><span class="token value attr-value">broker-a</span>
<span class="token comment">#brokerid,0就表示是Master，&gt;0的都是表示 Slave</span>
<span class="token key attr-name">brokerId</span><span class="token punctuation">=</span><span class="token value attr-value">0</span>
<span class="token comment">#nameServer地址，分号分割</span>
<span class="token key attr-name">namesrvAddr</span><span class="token punctuation">=</span><span class="token value attr-value">worker1:9876;worker2:9876;worker3:9876</span>
<span class="token comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span>
<span class="token key attr-name">defaultTopicQueueNums</span><span class="token punctuation">=</span><span class="token value attr-value">4</span>
<span class="token comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span>
<span class="token key attr-name">autoCreateTopicEnable</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span>
<span class="token key attr-name">autoCreateSubscriptionGroup</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#Broker 对外服务的监听端口</span>
<span class="token key attr-name">listenPort</span><span class="token punctuation">=</span><span class="token value attr-value">10911</span>
<span class="token comment">#删除文件时间点，默认凌晨 4点</span>
<span class="token key attr-name">deleteWhen</span><span class="token punctuation">=</span><span class="token value attr-value">04</span>
<span class="token comment">#文件保留时间，默认 48 小时</span>
<span class="token key attr-name">fileReservedTime</span><span class="token punctuation">=</span><span class="token value attr-value">120</span>
<span class="token comment">#commitLog每个文件的大小默认1G</span>
<span class="token key attr-name">mapedFileSizeCommitLog</span><span class="token punctuation">=</span><span class="token value attr-value">1073741824</span>
<span class="token comment">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span>
<span class="token key attr-name">mapedFileSizeConsumeQueue</span><span class="token punctuation">=</span><span class="token value attr-value">300000</span>
<span class="token comment">#destroyMapedFileIntervalForcibly=120000</span>
<span class="token comment">#redeleteHangedFileInterval=120000</span>
<span class="token comment">#检测物理文件磁盘空间</span>
<span class="token key attr-name">diskMaxUsedSpaceRatio</span><span class="token punctuation">=</span><span class="token value attr-value">88</span>
<span class="token comment">#存储路径</span>
<span class="token key attr-name">storePathRootDir</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/store</span>
<span class="token comment">#commitLog 存储路径</span>
<span class="token key attr-name">storePathCommitLog</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/store/commitlog</span>
<span class="token comment">#消费队列存储路径存储路径</span>
<span class="token key attr-name">storePathConsumeQueue</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/store/consumequeue</span>
<span class="token comment">#消息索引存储路径</span>
<span class="token key attr-name">storePathIndex</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/store/index</span>
<span class="token comment">#checkpoint 文件存储路径</span>
<span class="token key attr-name">storeCheckpoint</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/store/checkpoint</span>
<span class="token comment">#abort 文件存储路径</span>
<span class="token key attr-name">abortFile</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/store/abort</span>
<span class="token comment">#限制的消息大小</span>
<span class="token key attr-name">maxMessageSize</span><span class="token punctuation">=</span><span class="token value attr-value">65536</span>
<span class="token comment">#flushCommitLogLeastPages=4</span>
<span class="token comment">#flushConsumeQueueLeastPages=2</span>
<span class="token comment">#flushCommitLogThoroughInterval=10000</span>
<span class="token comment">#flushConsumeQueueThoroughInterval=60000</span>
<span class="token comment">#Broker 的角色</span>
<span class="token comment">#- ASYNC_MASTER 异步复制Master</span>
<span class="token comment">#- SYNC_MASTER 同步双写Master</span>
<span class="token comment">#- SLAVE</span>
<span class="token key attr-name">brokerRole</span><span class="token punctuation">=</span><span class="token value attr-value">ASYNC_MASTER</span>
<span class="token comment">#刷盘方式</span>
<span class="token comment">#- ASYNC_FLUSH 异步刷盘</span>
<span class="token comment">#- SYNC_FLUSH 同步刷盘</span>
<span class="token key attr-name">flushDiskType</span><span class="token punctuation">=</span><span class="token value attr-value">ASYNC_FLUSH</span>
<span class="token comment">#checkTransactionMessageEnable=false</span>
<span class="token comment">#发消息线程池数量</span>
<span class="token comment">#sendMessageThreadPoolNums=128</span>
<span class="token comment">#拉消息线程池数量</span>
<span class="token comment">#pullMessageThreadPoolNums=128</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>该节点对应的从节点在<strong>worker3</strong>上。修改2m-2s-async/broker-a-s.properties</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#所属集群名字，名字一样的节点就在同一个集群内</span>
<span class="token key attr-name">brokerClusterName</span><span class="token punctuation">=</span><span class="token value attr-value">rocketmq-cluster</span>
<span class="token comment">#broker名字，名字一样的节点就是一组主从节点。</span>
<span class="token key attr-name">brokerName</span><span class="token punctuation">=</span><span class="token value attr-value">broker-a</span>
<span class="token comment">#brokerid,0就表示是Master，&gt;0的都是表示 Slave</span>
<span class="token key attr-name">brokerId</span><span class="token punctuation">=</span><span class="token value attr-value">1</span>
<span class="token comment">#nameServer地址，分号分割</span>
<span class="token key attr-name">namesrvAddr</span><span class="token punctuation">=</span><span class="token value attr-value">worker1:9876;worker2:9876;worker3:9876</span>
<span class="token comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span>
<span class="token key attr-name">defaultTopicQueueNums</span><span class="token punctuation">=</span><span class="token value attr-value">4</span>
<span class="token comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span>
<span class="token key attr-name">autoCreateTopicEnable</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span>
<span class="token key attr-name">autoCreateSubscriptionGroup</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#Broker 对外服务的监听端口</span>
<span class="token key attr-name">listenPort</span><span class="token punctuation">=</span><span class="token value attr-value">11011</span>
<span class="token comment">#删除文件时间点，默认凌晨 4点</span>
<span class="token key attr-name">deleteWhen</span><span class="token punctuation">=</span><span class="token value attr-value">04</span>
<span class="token comment">#文件保留时间，默认 48 小时</span>
<span class="token key attr-name">fileReservedTime</span><span class="token punctuation">=</span><span class="token value attr-value">120</span>
<span class="token comment">#commitLog每个文件的大小默认1G</span>
<span class="token key attr-name">mapedFileSizeCommitLog</span><span class="token punctuation">=</span><span class="token value attr-value">1073741824</span>
<span class="token comment">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span>
<span class="token key attr-name">mapedFileSizeConsumeQueue</span><span class="token punctuation">=</span><span class="token value attr-value">300000</span>
<span class="token comment">#destroyMapedFileIntervalForcibly=120000</span>
<span class="token comment">#redeleteHangedFileInterval=120000</span>
<span class="token comment">#检测物理文件磁盘空间</span>
<span class="token key attr-name">diskMaxUsedSpaceRatio</span><span class="token punctuation">=</span><span class="token value attr-value">88</span>
<span class="token comment">#存储路径</span>
<span class="token key attr-name">storePathRootDir</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/storeSlave</span>
<span class="token comment">#commitLog 存储路径</span>
<span class="token key attr-name">storePathCommitLog</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/storeSlave/commitlog</span>
<span class="token comment">#消费队列存储路径存储路径</span>
<span class="token key attr-name">storePathConsumeQueue</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/storeSlave/consumequeue</span>
<span class="token comment">#消息索引存储路径</span>
<span class="token key attr-name">storePathIndex</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/storeSlave/index</span>
<span class="token comment">#checkpoint 文件存储路径</span>
<span class="token key attr-name">storeCheckpoint</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/storeSlave/checkpoint</span>
<span class="token comment">#abort 文件存储路径</span>
<span class="token key attr-name">abortFile</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/storeSlave/abort</span>
<span class="token comment">#限制的消息大小</span>
<span class="token key attr-name">maxMessageSize</span><span class="token punctuation">=</span><span class="token value attr-value">65536</span>
<span class="token comment">#flushCommitLogLeastPages=4</span>
<span class="token comment">#flushConsumeQueueLeastPages=2</span>
<span class="token comment">#flushCommitLogThoroughInterval=10000</span>
<span class="token comment">#flushConsumeQueueThoroughInterval=60000</span>
<span class="token comment">#Broker 的角色</span>
<span class="token comment">#- ASYNC_MASTER 异步复制Master</span>
<span class="token comment">#- SYNC_MASTER 同步双写Master</span>
<span class="token comment">#- SLAVE</span>
<span class="token key attr-name">brokerRole</span><span class="token punctuation">=</span><span class="token value attr-value">SLAVE</span>
<span class="token comment">#刷盘方式</span>
<span class="token comment">#- ASYNC_FLUSH 异步刷盘</span>
<span class="token comment">#- SYNC_FLUSH 同步刷盘</span>
<span class="token key attr-name">flushDiskType</span><span class="token punctuation">=</span><span class="token value attr-value">ASYNC_FLUSH</span>
<span class="token comment">#checkTransactionMessageEnable=false</span>
<span class="token comment">#发消息线程池数量</span>
<span class="token comment">#sendMessageThreadPoolNums=128</span>
<span class="token comment">#拉消息线程池数量</span>
<span class="token comment">#pullMessageThreadPoolNums=128</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>2、配置第二组Broker-b</strong></p><p>这一组broker的主节点在<strong>worker3</strong>上，所以需要配置worker3上的config/2m-2s-async/broker-b.properties</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#所属集群名字，名字一样的节点就在同一个集群内</span>
<span class="token key attr-name">brokerClusterName</span><span class="token punctuation">=</span><span class="token value attr-value">rocketmq-cluster</span>
<span class="token comment">#broker名字，名字一样的节点就是一组主从节点。</span>
<span class="token key attr-name">brokerName</span><span class="token punctuation">=</span><span class="token value attr-value">broker-b</span>
<span class="token comment">#brokerid,0就表示是Master，&gt;0的都是表示 Slave</span>
<span class="token key attr-name">brokerId</span><span class="token punctuation">=</span><span class="token value attr-value">0</span>
<span class="token comment">#nameServer地址，分号分割</span>
<span class="token key attr-name">namesrvAddr</span><span class="token punctuation">=</span><span class="token value attr-value">worker1:9876;worker2:9876;worker3:9876</span>
<span class="token comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span>
<span class="token key attr-name">defaultTopicQueueNums</span><span class="token punctuation">=</span><span class="token value attr-value">4</span>
<span class="token comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span>
<span class="token key attr-name">autoCreateTopicEnable</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span>
<span class="token key attr-name">autoCreateSubscriptionGroup</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#Broker 对外服务的监听端口</span>
<span class="token key attr-name">listenPort</span><span class="token punctuation">=</span><span class="token value attr-value">10911</span>
<span class="token comment">#删除文件时间点，默认凌晨 4点</span>
<span class="token key attr-name">deleteWhen</span><span class="token punctuation">=</span><span class="token value attr-value">04</span>
<span class="token comment">#文件保留时间，默认 48 小时</span>
<span class="token key attr-name">fileReservedTime</span><span class="token punctuation">=</span><span class="token value attr-value">120</span>
<span class="token comment">#commitLog每个文件的大小默认1G</span>
<span class="token key attr-name">mapedFileSizeCommitLog</span><span class="token punctuation">=</span><span class="token value attr-value">1073741824</span>
<span class="token comment">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span>
<span class="token key attr-name">mapedFileSizeConsumeQueue</span><span class="token punctuation">=</span><span class="token value attr-value">300000</span>
<span class="token comment">#destroyMapedFileIntervalForcibly=120000</span>
<span class="token comment">#redeleteHangedFileInterval=120000</span>
<span class="token comment">#检测物理文件磁盘空间</span>
<span class="token key attr-name">diskMaxUsedSpaceRatio</span><span class="token punctuation">=</span><span class="token value attr-value">88</span>
<span class="token comment">#存储路径</span>
<span class="token key attr-name">storePathRootDir</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/store</span>
<span class="token comment">#commitLog 存储路径</span>
<span class="token key attr-name">storePathCommitLog</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/store/commitlog</span>
<span class="token comment">#消费队列存储路径存储路径</span>
<span class="token key attr-name">storePathConsumeQueue</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/store/consumequeue</span>
<span class="token comment">#消息索引存储路径</span>
<span class="token key attr-name">storePathIndex</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/store/index</span>
<span class="token comment">#checkpoint 文件存储路径</span>
<span class="token key attr-name">storeCheckpoint</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/store/checkpoint</span>
<span class="token comment">#abort 文件存储路径</span>
<span class="token key attr-name">abortFile</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/store/abort</span>
<span class="token comment">#限制的消息大小</span>
<span class="token key attr-name">maxMessageSize</span><span class="token punctuation">=</span><span class="token value attr-value">65536</span>
<span class="token comment">#flushCommitLogLeastPages=4</span>
<span class="token comment">#flushConsumeQueueLeastPages=2</span>
<span class="token comment">#flushCommitLogThoroughInterval=10000</span>
<span class="token comment">#flushConsumeQueueThoroughInterval=60000</span>
<span class="token comment">#Broker 的角色</span>
<span class="token comment">#- ASYNC_MASTER 异步复制Master</span>
<span class="token comment">#- SYNC_MASTER 同步双写Master</span>
<span class="token comment">#- SLAVE</span>
<span class="token key attr-name">brokerRole</span><span class="token punctuation">=</span><span class="token value attr-value">ASYNC_MASTER</span>
<span class="token comment">#刷盘方式</span>
<span class="token comment">#- ASYNC_FLUSH 异步刷盘</span>
<span class="token comment">#- SYNC_FLUSH 同步刷盘</span>
<span class="token key attr-name">flushDiskType</span><span class="token punctuation">=</span><span class="token value attr-value">ASYNC_FLUSH</span>
<span class="token comment">#checkTransactionMessageEnable=false</span>
<span class="token comment">#发消息线程池数量</span>
<span class="token comment">#sendMessageThreadPoolNums=128</span>
<span class="token comment">#拉消息线程池数量</span>
<span class="token comment">#pullMessageThreadPoolNums=128</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后他对应的slave在worker2上，修改work2上的 conf/2m-2s-async/broker-b-s.properties</p><div class="language-properties line-numbers-mode" data-ext="properties"><pre class="language-properties"><code><span class="token comment">#所属集群名字，名字一样的节点就在同一个集群内</span>
<span class="token key attr-name">brokerClusterName</span><span class="token punctuation">=</span><span class="token value attr-value">rocketmq-cluster</span>
<span class="token comment">#broker名字，名字一样的节点就是一组主从节点。</span>
<span class="token key attr-name">brokerName</span><span class="token punctuation">=</span><span class="token value attr-value">broker-b</span>
<span class="token comment">#brokerid,0就表示是Master，&gt;0的都是表示 Slave</span>
<span class="token key attr-name">brokerId</span><span class="token punctuation">=</span><span class="token value attr-value">1</span>
<span class="token comment">#nameServer地址，分号分割</span>
<span class="token key attr-name">namesrvAddr</span><span class="token punctuation">=</span><span class="token value attr-value">worker1:9876;worker2:9876;worker3:9876</span>
<span class="token comment">#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数</span>
<span class="token key attr-name">defaultTopicQueueNums</span><span class="token punctuation">=</span><span class="token value attr-value">4</span>
<span class="token comment">#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭</span>
<span class="token key attr-name">autoCreateTopicEnable</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭</span>
<span class="token key attr-name">autoCreateSubscriptionGroup</span><span class="token punctuation">=</span><span class="token value attr-value">true</span>
<span class="token comment">#Broker 对外服务的监听端口</span>
<span class="token key attr-name">listenPort</span><span class="token punctuation">=</span><span class="token value attr-value">11011</span>
<span class="token comment">#删除文件时间点，默认凌晨 4点</span>
<span class="token key attr-name">deleteWhen</span><span class="token punctuation">=</span><span class="token value attr-value">04</span>
<span class="token comment">#文件保留时间，默认 48 小时</span>
<span class="token key attr-name">fileReservedTime</span><span class="token punctuation">=</span><span class="token value attr-value">120</span>
<span class="token comment">#commitLog每个文件的大小默认1G</span>
<span class="token key attr-name">mapedFileSizeCommitLog</span><span class="token punctuation">=</span><span class="token value attr-value">1073741824</span>
<span class="token comment">#ConsumeQueue每个文件默认存30W条，根据业务情况调整</span>
<span class="token key attr-name">mapedFileSizeConsumeQueue</span><span class="token punctuation">=</span><span class="token value attr-value">300000</span>
<span class="token comment">#destroyMapedFileIntervalForcibly=120000</span>
<span class="token comment">#redeleteHangedFileInterval=120000</span>
<span class="token comment">#检测物理文件磁盘空间</span>
<span class="token key attr-name">diskMaxUsedSpaceRatio</span><span class="token punctuation">=</span><span class="token value attr-value">88</span>
<span class="token comment">#存储路径</span>
<span class="token key attr-name">storePathRootDir</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/storeSlave</span>
<span class="token comment">#commitLog 存储路径</span>
<span class="token key attr-name">storePathCommitLog</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/storeSlave/commitlog</span>
<span class="token comment">#消费队列存储路径存储路径</span>
<span class="token key attr-name">storePathConsumeQueue</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/storeSlave/consumequeue</span>
<span class="token comment">#消息索引存储路径</span>
<span class="token key attr-name">storePathIndex</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/storeSlave/index</span>
<span class="token comment">#checkpoint 文件存储路径</span>
<span class="token key attr-name">storeCheckpoint</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/storeSlave/checkpoint</span>
<span class="token comment">#abort 文件存储路径</span>
<span class="token key attr-name">abortFile</span><span class="token punctuation">=</span><span class="token value attr-value">/app/rocketmq/storeSlave/abort</span>
<span class="token comment">#限制的消息大小</span>
<span class="token key attr-name">maxMessageSize</span><span class="token punctuation">=</span><span class="token value attr-value">65536</span>
<span class="token comment">#flushCommitLogLeastPages=4</span>
<span class="token comment">#flushConsumeQueueLeastPages=2</span>
<span class="token comment">#flushCommitLogThoroughInterval=10000</span>
<span class="token comment">#flushConsumeQueueThoroughInterval=60000</span>
<span class="token comment">#Broker 的角色</span>
<span class="token comment">#- ASYNC_MASTER 异步复制Master</span>
<span class="token comment">#- SYNC_MASTER 同步双写Master</span>
<span class="token comment">#- SLAVE</span>
<span class="token key attr-name">brokerRole</span><span class="token punctuation">=</span><span class="token value attr-value">SLAVE</span>
<span class="token comment">#刷盘方式</span>
<span class="token comment">#- ASYNC_FLUSH 异步刷盘</span>
<span class="token comment">#- SYNC_FLUSH 同步刷盘</span>
<span class="token key attr-name">flushDiskType</span><span class="token punctuation">=</span><span class="token value attr-value">ASYNC_FLUSH</span>
<span class="token comment">#checkTransactionMessageEnable=false</span>
<span class="token comment">#发消息线程池数量</span>
<span class="token comment">#sendMessageThreadPoolNums=128</span>
<span class="token comment">#拉消息线程池数量</span>
<span class="token comment">#pullMessageThreadPoolNums=128</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这样2主2从的集群配置基本就完成了。搭建过程中需要注意的配置项：</p><p>1、同一机器上两个实例的store目录不能相同，否则会报错 Lock failed,MQ already started 2、同一机器上两个实例的listenPort也不能相同。否则会报端口占用的错 nameserver不需要进行配置，直接启动就行。这也看出nameserver是无状态的。 3、<strong>如果是多网卡的机器，比如云服务器，那么需要在broker.conf中增加brokerIP1属性，指定所在机器的外网网卡地址。</strong></p><h4 id="启动rocketmq" tabindex="-1"><a class="header-anchor" href="#启动rocketmq" aria-hidden="true">#</a> 启动RocketMQ</h4><p>启动就比较简单了，直接调用bin目录下的脚本就行。只是启动之前要注意看下他们的JVM内存配置，默认的配置都比较高。</p><p><strong>1、先启动nameServer</strong></p><p>修改三个节点上的bin/runserver.sh，调整里面的jvm内存配置。找到下面这一行调整下内存</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">JAVA_OPT</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${JAVA_OPT}</span> -server -Xms512m -Xmx512m -Xmn256m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>直接在三个节点上启动nameServer。</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>nohup bin/mqnamesrv &amp;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>启动完成后，在nohup.out里看到这一条关键日志就是启动成功了。</p><p>Java HotSpot(TM) 64-Bit Server VM warning: Using the DefNew young collector with the CMS collector is deprecated and will likely be removed in a future release Java HotSpot(TM) 64-Bit Server VM warning: UseCMSCompactAtFullCollection is deprecated and will likely be removed in a future release.</p><!----><p>使用jps指令可以看到一个NamesrvStartup进程。</p><blockquote><p>这里也看到，RocketMQ在runserver.sh中是使用的CMS垃圾回收期，而在runbroker.sh中使用的是G1垃圾回收期。</p></blockquote><p><strong>2、再启动broker</strong></p><p>启动broker是使用的mqbroker指令，只是注意启动broker时需要通过-c 指定对应的配置文件。</p><p>在<strong>worker2</strong>上启动broker-a的master节点和broker-b的slave节点</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">nohup</span> ./mqbroker <span class="token parameter variable">-c</span> <span class="token punctuation">..</span>/conf/2m-2s-async/broker-a.properties <span class="token operator">&amp;</span>
<span class="token function">nohup</span> ./mqbroker <span class="token parameter variable">-c</span> <span class="token punctuation">..</span>/conf/2m-2s-async/broker-b-s.properties <span class="token operator">&amp;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>在work3上启动broker-b的master节点和broker-a的slave节点</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token function">nohup</span> ./mqbroker <span class="token parameter variable">-c</span> <span class="token punctuation">..</span>/conf/2m-2s-async/broker-b.properties <span class="token operator">&amp;</span>
<span class="token function">nohup</span> ./mqbroker <span class="token parameter variable">-c</span> <span class="token punctuation">..</span>/conf/2m-2s-async/broker-a-s.properties <span class="token operator">&amp;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>启动slave时，如果遇到报错 Lock failed,MQ already started ，那是因为有多个实例共用了同一个storePath造成的，这时就需要调整store的路径。</p></blockquote><p><strong>3、启动状态检查</strong></p><p>使用jps指令，能看到一个NameSrvStartup进程和两个BrokerStartup进程。</p><p>nohup.out中也有启动成功的日志。</p><p>对应的日志文件：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token comment"># 查看nameServer日志</span>
<span class="token function">tail</span> <span class="token parameter variable">-500f</span> ~/logs/rocketmqlogs/namesrv.log
<span class="token comment"># 查看broker日志</span>
<span class="token function">tail</span> <span class="token parameter variable">-500f</span> ~/logs/rocketmqlogs/broker.log
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>4、测试mqadmin管理工具</strong></p><p>​ RocketMQ源码中并没有提供管理控制台，只提供了一个mqadmin指令来管理RocketMQ。指令的位置在bin目录下。直接使用该指令就会列出所有支持的命令。</p><figure><img src="https://img.jssjqd.cn/202211131352409.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>使用方式都是 <strong>mqadmin {command} {args}</strong>。 如果有某个指令不会使用，可以使用 <strong>mqadmin help {command}</strong> 指令查看帮助。</p><p><strong>5、命令行快速验证</strong></p><p>​ RocketMQ提供了一个tools.sh工具可以用来在命令行快速验证RocketMQ服务。例如，在worker2机器上进入RocketMQ的安装目录：</p><p>发送消息：默认会发1000条消息</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>bin/tools.sh org.apache.rocketmq.example.quickstart.Producer
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>接收消息：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>bin/tools.sh  org.apache.rocketmq.example.quickstart.Consumer
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><blockquote><p>注意，这是官方提供的Demo，但是官方的源码中，这两个类都是没有指定nameServer的，所以运行会有点问题。要指定NameServer地址，可以配置一个环境变量NAMESRV_ADDR，这样默认会读取这个NameServer地址。可以配到.bash_profile里或者直接临时指定。</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token builtin class-name">export</span> <span class="token assign-left variable">NAMESRV_ADDR</span><span class="token operator">=</span><span class="token string">&#39;worker1:9876;worker2:9876;worker3:9876&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>然后就可以正常执行了。</p></blockquote><p>这个tooles.sh实际上是封装了一个简单的运行RocketMQ的环境，上面指令中指定的Java类，都在lib/rocketmq-example-4.7.1.jar包中。未来如果自己有一些客户端示例，也可以打成jar包放到这个lib目录下，通过tools.sh运行。</p><h4 id="搭建管理控制台" tabindex="-1"><a class="header-anchor" href="#搭建管理控制台" aria-hidden="true">#</a> 搭建管理控制台</h4><p>RocketMQ源代码中并没有提供控制台，但是有一个Rocket的社区扩展项目中提供了一个控制台，地址： <a href="https://github.com/apache/rocketmq-dashboard" target="_blank" rel="noopener noreferrer">https://github.com/apache/rocketmq-dashboard<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>下载下来后，解压并进入对应的目录，使用maven进行编译</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mvn clean package <span class="token parameter variable">-Dmaven.test.skip</span><span class="token operator">=</span>true
 mvn clean <span class="token function">install</span> package <span class="token string">&#39;-Dmaven.test.skip=true&#39;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>编译完成后，获取target下的jar包，就可以直接执行。但是这个时候要注意，在这个项目的application.yml中需要指定nameserver的地址。默认这个属性是指向本地。如果配置为空，会读取环境变量NAMESRV_ADDR。</p><p>那我们可以在jar包的当前目录下增加一个application.yml文件，覆盖jar包中默认的一个属性：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>rocketmq:
  config:
    namesrvAddrs:
      - worker1:9876
      - worker2:9876
      - worker3:9876
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后执行：</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>java -jar rocketmq-dashboard-1.0.1-SNAPSHOT.jar
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>启动完成后，可以访问 http://192.168.232.128:8080看到管理页面</p><h4 id="搭建dledger高可用集群-了解" tabindex="-1"><a class="header-anchor" href="#搭建dledger高可用集群-了解" aria-hidden="true">#</a> 搭建Dledger高可用集群--了解</h4><p>​ 通过这种方式，我们搭建了一个主从结构的RocketMQ集群，但是我们要注意，这种主从结构是只做数据备份，没有容灾功能的。也就是说当一个master节点挂了后，slave节点是无法切换成master节点继续提供服务的。注意这个集群至少要是3台，允许少于一半的节点发生故障。</p><blockquote><p>如果slave挂了，对集群的影响不会很大，因为slave只是做数据备份的。但是影响也是会有的，例如，当消费者要拉取的数据量比较大时，RocketMQ有一定的机制会优先保证Master节点的性能，只让Master节点返回一小部分数据，而让其他部分的数据从slave节点去拉取。</p><p>另外，需要注意，Dleger会有他自己的CommitLog机制，也就是说，使用主从集群累计下来的消息，是无法转移到Dleger集群中的。</p></blockquote><p>​ 而如果要进行高可用的容灾备份，需要采用Dledger的方式来搭建高可用集群。注意，这个Dledger需要在RocketMQ4.5以后的版本才支持，我们使用的4.7.1版本已经默认集成了dledger。</p><p><strong>搭建方法</strong></p><p>​ 要搭建高可用的Broker集群，我们只需要配置conf/dleger下的配置文件就行。</p><blockquote><p>这种模式是基于Raft协议的，是一个类似于Zookeeper的paxos协议的选举协议，也是会在集群中随机选举出一个leader，其他的就是follower。只是他选举的过程跟paxos有点不同。Raft协议基于随机休眠机制的，选举过程会比paxos相对慢一点。</p></blockquote><p>​ 首先：<a href="http://xn--runserver-947nw2gmts9m8bkijnsdy1kk96m302b.xn--shrunbroker-804s.sh" target="_blank" rel="noopener noreferrer">我们同样是需要修改runserver.sh和runbroker.sh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，对JVM内存进行定制。</p><p>​ 然后：我们需要修改conf/dleger下的配置文件。 跟dleger相关的几个配置项如下：</p><table><thead><tr><th>name</th><th>含义</th><th>举例</th></tr></thead><tbody><tr><td>enableDLegerCommitLog</td><td>是否启动 DLedger</td><td>true</td></tr><tr><td>dLegerGroup</td><td>DLedger Raft Group的名字，建议和 brokerName 保持一致</td><td>RaftNode00</td></tr><tr><td>dLegerPeers</td><td>DLedger Group 内各节点的端口信息，同一个 Group 内的各个节点配置必须要保证一致</td><td>n0-127.0.0.1:40911;n1-127.0.0.1:40912;n2-127.0.0.1:40913</td></tr><tr><td>dLegerSelfId</td><td>节点 id, 必须属于 dLegerPeers 中的一个；同 Group 内各个节点要唯一</td><td>n0</td></tr><tr><td>sendMessageThreadPoolNums</td><td>发送线程个数，建议配置成 Cpu 核数</td><td>16</td></tr></tbody></table><p>配置完后，同样是使用 nohup bin/mqbroker -c $conf_name &amp; 的方式指定实例文件。</p><blockquote><p>在bin/dleger下有个fast-try.sh，这个脚本是在本地启动三个RocketMQ实例，搭建一个高可用的集群，读取的就是conf/dleger下的broker-no.conf，broker-n1.conf和broker-n2.conf。使用这个脚本同样要注意定制下JVM内存，他给每个实例默认定制的是1G内存，虚拟机肯定是不够的。</p><p>这种单机三实例的集群搭建完成后，可以使用 bin/mqadmin clusterList -n worker1.conf的方式查看集群状态。</p></blockquote><h4 id="系统参数调优-重要" tabindex="-1"><a class="header-anchor" href="#系统参数调优-重要" aria-hidden="true">#</a> 系统参数调优 -- 重要</h4><p>到这里，我们的整个RocketMQ的服务就搭建完成了。但是在实际使用时，我们说RocketMQ的吞吐量、性能都很高，那要发挥RocketMQ的高性能，还需要对RocketMQ以及服务器的性能进行定制</p><p><strong>1、配置RocketMQ的JVM内存大小：</strong></p><p>之前提到过，在runserver.sh中需要定制nameserver的内存大小，在runbroker.sh中需要定制broker的内存大小。这些默认的配置可以认为都是经过检验的最优化配置，但是在实际情况中都还需要根据服务器的实际情况进行调整。这里以runbroker.sh中对G1GC的配置举例，在runbroker.sh中的关键配置：</p><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token assign-left variable">JAVA_OPT</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${JAVA_OPT}</span> -XX:+UseG1GC -XX:G1HeapRegionSize=16m -XX:G1ReservePercent=25 -XX:InitiatingHeapOccupancyPercent=30 -XX:SoftRefLRUPolicyMSPerMB=0&quot;</span>
<span class="token assign-left variable">JAVA_OPT</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${JAVA_OPT}</span> -verbose:gc -Xloggc:<span class="token variable">${GC_LOG_DIR}</span>/rmq_broker_gc_%p_%t.log -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCApplicationStoppedTime -XX:+PrintAdaptiveSizePolicy&quot;</span>
<span class="token assign-left variable">JAVA_OPT</span><span class="token operator">=</span><span class="token string">&quot;<span class="token variable">${JAVA_OPT}</span> -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=30m&quot;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>-XX:+UseG1GC: 使用G1垃圾回收器， -XX:G1HeapRegionSize=16m 将G1的region块大小设为16M，-XX:G1ReservePercent：在G1的老年代中预留25%空闲内存，这个默认值是10%，RocketMQ把这个参数调大了。-XX:InitiatingHeapOccupancyPercent=30：当堆内存的使用率达到30%之后就会启动G1垃圾回收器尝试回收垃圾，默认值是45%，RocketMQ把这个参数调小了，也就是提高了GC的频率，但是避免了垃圾对象过多，一次垃圾回收时间太长的问题。</p><p>然后，后面定制了GC的日志文件，确定GC日志文件的地址、打印的内容以及控制每个日志文件的大小为30M并且只保留5个文件。这些在进行性能检验时，是相当重要的参考内容。</p><p><strong>2、RocketMQ的其他一些核心参数</strong></p><p>例如在conf/dleger/broker-n0.conf中有一个参数：sendMessageThreadPoolNums=16。这一个参数是表明RocketMQ内部用来发送消息的线程池的线程数量是16个，其实这个参数可以根据机器的CPU核心数进行适当调整，例如如果你的机器核心数超过16个，就可以把这个参数适当调大。</p><p><strong>3、Linux内核参数定制</strong></p><p>我们在部署RocketMQ的时候，还需要对Linux内核参数进行一定的定制。例如</p><ul><li><strong>ulimit</strong>，需要进行大量的网络通信和磁盘IO。</li><li><strong>vm.extra_free_kbytes</strong>，告诉VM在后台回收（kswapd）启动的阈值与直接回收（通过分配进程）的阈值之间保留额外的可用内存。RocketMQ使用此参数来避免内存分配中的长延迟。（与具体内核版本相关）</li><li><strong>vm.min_free_kbytes</strong>，如果将其设置为低于1024KB，将会巧妙的将系统破坏，并且系统在高负载下容易出现死锁。</li><li><strong>vm.max_map_count</strong>，限制一个进程可能具有的最大内存映射区域数。RocketMQ将使用mmap加载CommitLog和ConsumeQueue，因此建议将为此参数设置较大的值。</li><li><strong>vm.swappiness</strong>，定义内核交换内存页面的积极程度。较高的值会增加攻击性，较低的值会减少交换量。建议将值设置为10来避免交换延迟。</li><li><strong>File descriptor limits</strong>，RocketMQ需要为文件（CommitLog和ConsumeQueue）和网络连接打开文件描述符。我们建议设置文件描述符的值为655350。</li></ul><blockquote><p>这些参数在CentOS7中的配置文件都在 /proc/sys/vm目录下。</p><p>另外，RocketMQ的bin目录下有个os.sh里面设置了RocketMQ建议的系统内核参数，可以根据情况进行调整。</p></blockquote><h2 id="rocketmq消息转发模型" tabindex="-1"><a class="header-anchor" href="#rocketmq消息转发模型" aria-hidden="true">#</a> RocketMQ消息转发模型</h2><p>​ 这一部分我们可以结合一下管理控制台，先来理解下RocketMQ的一些重要的基础概念：</p><h3 id="消息模型-message-model" tabindex="-1"><a class="header-anchor" href="#消息模型-message-model" aria-hidden="true">#</a> 消息模型（Message Model）</h3><p>​ RocketMQ主要由 Producer、Broker、Consumer 三部分组成，其中Producer 负责生产消息，Consumer 负责消费消息，Broker 负责存储消息。Broker 在实际部署过程中对应一台服务器，每个 Broker 可以存储多个Topic的消息，每个Topic的消息也可以分片存储于不同的 Broker。Message Queue 用于存储消息的物理地址，每个Topic中的消息地址存储于多个 Message Queue 中。ConsumerGroup 由多个Consumer 实例构成。</p><h3 id="消息生产者-producer" tabindex="-1"><a class="header-anchor" href="#消息生产者-producer" aria-hidden="true">#</a> 消息生产者（Producer）</h3><p>​ 负责生产消息，一般由业务系统负责生产消息。一个消息生产者会把业务应用系统里产生的消息发送到broker服务器。RocketMQ提供多种发送方式，同步发送、异步发送、顺序发送、单向发送。同步和异步方式均需要Broker返回确认信息，单向发送不需要。</p><h3 id="消息消费者-consumer" tabindex="-1"><a class="header-anchor" href="#消息消费者-consumer" aria-hidden="true">#</a> 消息消费者（Consumer）</h3><p>​ 负责消费消息，一般是后台系统负责异步消费。一个消息消费者会从Broker服务器拉取消息、并将其提供给应用程序。从用户应用的角度而言提供了两种消费形式：拉取式消费、推动式消费。</p><ul><li><p>拉取式消费的应用通常主动调用Consumer的拉消息方法从Broker服务器拉消息、主动权由应用控制。一旦获取了批量消息，应用就会启动消费过程。</p></li><li><p>推动式消费模式下Broker收到数据后会主动推送给消费端，该消费模式一般实时性较高。</p></li></ul><p>​ 消费者同样会把同一类Consumer组成一个集合，叫做消费者组，这类Consumer通常消费同一类消息且消费逻辑一致。消费者组使得在消息消费方面，实现负载均衡和容错的目标变得非常容易。要注意的是，消费者组的消费者实例必须订阅完全相同的Topic。RocketMQ 支持两种消息模式：集群消费（Clustering）和广播消费（Broadcasting）。</p><ul><li>集群消费模式下, 相同Consumer Group的每个Consumer实例平均分摊消息。</li><li>广播消费模式下，相同Consumer Group的每个Consumer实例都接收全量的消息。</li></ul><h3 id="主题-topic" tabindex="-1"><a class="header-anchor" href="#主题-topic" aria-hidden="true">#</a> 主题（Topic）</h3><p>​ 表示一类消息的集合，每个主题包含若干条消息，每条消息只能属于一个主题，是RocketMQ进行消息订阅的基本单位。</p><p>​ Topic只是一个逻辑概念，并不实际保存消息。同一个Topic下的消息，会分片保存到不同的Broker上，而每一个分片单位，就叫做MessageQueue。MessageQueue是一个具有FIFO特性的队列结构，生产者发送消息与消费者消费消息的最小单位。</p><h3 id="代理服务器-broker-server" tabindex="-1"><a class="header-anchor" href="#代理服务器-broker-server" aria-hidden="true">#</a> 代理服务器（Broker Server）</h3><p>​ 消息中转角色，负责存储消息、转发消息。代理服务器在RocketMQ系统中负责接收从生产者发送来的消息并存储、同时为消费者的拉取请求作准备。代理服务器也存储消息相关的元数据，包括消费者组、消费进度偏移和主题和队列消息等。</p><p>Broker Server是RocketMQ真正的业务核心，包含了多个重要的子模块：</p><ul><li>Remoting Module：整个Broker的实体，负责处理来自clients端的请求。</li><li>Client Manager：负责管理客户端(Producer/Consumer)和维护Consumer的Topic订阅信息</li><li>Store Service：提供方便简单的API接口处理消息存储到物理硬盘和查询功能。</li><li>HA Service：高可用服务，提供Master Broker 和 Slave Broker之间的数据同步功能。</li><li>Index Service：根据特定的Message key对投递到Broker的消息进行索引服务，以提供消息的快速查询。</li></ul><p>而Broker Server要保证高可用需要搭建主从集群架构。RocketMQ中有两种Broker架构模式：</p><ul><li>普通集群：</li></ul><p>这种集群模式下会给每个节点分配一个固定的角色，master负责响应客户端的请求，并存储消息。slave则只负责对master的消息进行同步保存，并响应部分客户端的读请求。消息同步方式分为同步同步和异步同步。</p><p>这种集群模式下各个节点的角色无法进行切换，也就是说，master节点挂了，这一组Broker就不可用了。</p><ul><li>Dledger高可用集群：</li></ul><p>Dledger是RocketMQ自4.5版本引入的实现高可用集群的一项技术。这个模式下的集群会随机选出一个节点作为master，而当master节点挂了后，会从slave中自动选出一个节点升级成为master。</p><p>Dledger技术做的事情：1、从集群中选举出master节点 2、完成master节点往slave节点的消息同步。</p><h3 id="名字服务-name-server" tabindex="-1"><a class="header-anchor" href="#名字服务-name-server" aria-hidden="true">#</a> 名字服务（Name Server）</h3><p>​ 名称服务充当路由消息的提供者。Broker Server会在启动时向所有的Name Server注册自己的服务信息，并且后续通过心跳请求的方式保证这个服务信息的实时性。生产者或消费者能够通过名字服务查找各主题相应的Broker IP列表。多个Namesrv实例组成集群，但相互独立，没有信息交换。</p><p>​ 这种特性也就意味着NameServer中任意的节点挂了，只要有一台服务节点正常，整个路由服务就不会有影响。当然，这里不考虑节点的负载情况。</p><h3 id="消息-message" tabindex="-1"><a class="header-anchor" href="#消息-message" aria-hidden="true">#</a> 消息（Message）</h3><p>​ 消息系统所传输信息的物理载体，生产和消费数据的最小单位，每条消息必须属于一个主题Topic。RocketMQ中每个消息拥有唯一的Message ID，且可以携带具有业务标识的Key。系统提供了通过Message ID和Key查询消息的功能。</p><p>​ 并且Message上有一个为消息设置的标志，Tag标签。用于同一主题下区分不同类型的消息。来自同一业务单元的消息，可以根据不同业务目的在同一主题下设置不同标签。标签能够有效地保持代码的清晰度和连贯性，并优化RocketMQ提供的查询系统。消费者可以根据Tag实现对不同子主题的不同消费逻辑，实现更好的扩展性。</p><blockquote><p>关于Message的更详细字段，在源码的docs/cn/best_practice.md中有详细介绍。</p></blockquote><p>整体的基础概念如下图总结：</p><figure><img src="https://img.jssjqd.cn/202211131352106.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>其中有一些比较常见的面试题需要注意一下：</p><p>1、为什么RocketMQ不用Zookeeper而要自己实现一个NameServer来进行注册？</p><p>2、Consumer分组有什么用？Producer分组呢？</p><p>3、RocketMQ如何保证集群服务高可用？</p></div><!----><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">上次编辑于: </span><!----></div><div class="contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: thejqd@gmail.com">jiangqingdong</span><!--]--><!--]--></div></div></footer><!----><!----><!----><!--]--></main><!--]--><footer class="footer-wrapper"><!----><div class="copyright">Copyright © 2023 江</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app-21ce620e.js" defer></script>
  </body>
</html>
